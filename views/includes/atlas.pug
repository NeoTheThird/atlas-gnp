#osm-map
script(type='text/javascript').
  function getUrlParameters() {
    let ret = {};
    window.location.href.replace(
      /[?&]+([^=&]+)=([^&]*)/gi,
      (_, property, value) => {
        ret[property] = value;
      }
    );
    return ret;
  }

  const settings = Object.assign({
      lat: 51,
      long: 10.3,
      zoom: 6,
      radius: 45
    }, getUrlParameters()
  );

  console.log(settings);

  var element = document.getElementById('osm-map');
  element.style = 'height:100vh;';
  var map = L.map(element);
  L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright" target="_blank">OpenStreetMap</a> contributors | <a href="https://gesellschaft-fuer-neuropaediatrie.org/" target="_blank">Gesellschaft für Neuropädiatrie</a>'
  }).addTo(map);
  map.setView(L.latLng(settings.lat,settings.long), settings.zoom);

  function getIcon(member) {
    let type = member.popup ? "_full" : "_half"
    return new L.icon({
      iconUrl: '/img/pin_' + member.color + type + '.svg',
      shadowUrl: '/img/shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
  }

  var legend = L.control({position: 'bottomleft'});
  legend.onAdd = function (map) {
    let div = L.DomUtil.create('div', 'info legend');
    let labels = ['<strong>Legende</strong>'];
    let categories = [
      { color: "#003777", type: "ord. Mitglied" },
      { color: "#3EA9E9", type: "Juniormitglied" },
      { color: "#000000", type: "außerord. Mitglied" },
      { color: "#FFDC32", type: "Ehrenmitglied" },
      { color: "#888888", type: "Seniormitglied" }
    ];

    categories.forEach(c => {
      labels.push('<span class="dot" style="background-color: ' + c.color + ';"></span> ' + c.type);
    });
    div.innerHTML = labels.join('<br>');
    return div;
  };
  legend.addTo(map);

  const Http = new XMLHttpRequest();
  const url='/api/getAtlas';
  Http.open("GET", url);
  Http.send();

  let added = false
  Http.onreadystatechange = (e) => {
    console.log(e);
    let members = JSON.parse(Http.responseText);

    if (!added) {
      added = true;
      let markers = L.markerClusterGroup({
        maxClusterRadius: settings.radius
      });
      members.forEach(member => {
        let marker = L.marker(
          member.latlong,
          {
            title: member.name,
            icon: getIcon(member)
          }
        );
        if (member.popup) {
          marker.bindPopup(member.popup);
        }
        markers.addLayer(marker);
      });
      map.addLayer(markers);
    }
  }
